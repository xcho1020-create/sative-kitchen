<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sative Kitchen</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f9fa; color: #2c3e50; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    header { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; }
    header .container { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
    .logo { font-size: 24px; font-weight: 700; color: #2c3e50; }
    .user-info { display: flex; align-items: center; gap: 15px; font-size: 14px; }
    .role-badge { background: #e8f4f8; color: #1a7f8f; padding: 6px 12px; border-radius: 20px; font-weight: 600; }
    button { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; }
    button:hover { background: #1a252f; }
    button.secondary { background: #95a5a6; }
    button.secondary:hover { background: #7f8c8d; }
    button.primary { background: #1a7f8f; }
    button.primary:hover { background: #156873; }
    button.danger { background: #e74c3c; padding: 6px 12px; font-size: 13px; }
    button.danger:hover { background: #c0392b; }
    button.edit-btn { background: #3498db; padding: 6px 12px; font-size: 13px; }
    button.edit-btn:hover { background: #2980b9; }
    [data-page] { display: none; }
    .login-container { max-width: 400px; margin: 60px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .login-container h1 { font-size: 28px; margin-bottom: 10px; text-align: center; }
    .login-container p { text-align: center; margin-bottom: 30px; color: #7f8c8d; font-size: 14px; }
    .delivery-card { background: #ffffff; padding: 24px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 20px; }
    .delivery-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; }
    .delivery-header-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .delivery-header-info:hover .delivery-date { color: #0f172a; }
    .delivery-date { font-weight: 700; font-size: 18px; color: #111827; }
    .payment-badge { font-weight: 600; font-size: 13px; text-transform: capitalize; padding: 4px 12px; border-radius: 16px; color: #ffffff; }
    .payment-badge.paid { background: #10b981; }
    .payment-badge.unpaid { background: #ef4444; }
    .button-compact { padding: 6px 14px; font-size: 13px; border-radius: 9999px; }
    .delivery-metrics { display: flex; gap: 20px; justify-content: space-between; flex-wrap: wrap; }
    .metric { flex: 1 1 120px; display: flex; flex-direction: column; gap: 6px; }
    .metric-label { text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: #6b7280; }
    .metric-value { font-size: 18px; font-weight: 700; color: #374151; }
    .metric-value.cost { color: #4b5563; }
    .metric-value.sell { color: #10b981; }
    .metric-value.margin-positive { color: #2563eb; }
    .metric-value.margin-negative { color: #ef4444; }
    .sell-positive { color: #10b981; }
    .margin-positive { color: #2563eb; }
    .margin-negative { color: #ef4444; }
    .delivery-actions-row { display: flex; justify-content: flex-end; }
    .delivery-actions { display: flex; gap: 10px; }
    .action-button { padding: 6px 16px; border-radius: 9999px; font-size: 13px; font-weight: 600; transition: opacity 0.2s ease, transform 0.2s ease; }
    .action-button.mark-paid { background: #10b981; color: #ffffff; }
    .action-button.mark-unpaid { background: #f97316; color: #ffffff; }
    .action-button:hover { transform: translateY(-1px); }
    button:disabled, .action-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    @media (max-width: 600px) {
      .delivery-card { padding: 20px; }
      .delivery-metrics { gap: 16px; }
      .metric { flex-basis: 100%; }
      .delivery-actions-row { justify-content: stretch; }
      .delivery-actions { width: 100%; justify-content: flex-end; flex-wrap: wrap; }
    }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
    .products-list { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; max-height: 400px; overflow-y: auto; }
    .product-item { background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: center; }
    .product-item input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
    .admin-products .product-row { background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .admin-products .product-name { flex: 1; font-weight: 500; }
    .admin-products .product-prices { display: flex; gap: 10px; }
    .admin-products .product-prices input { width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    .detail-summary { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .detail-summary h3 { margin-bottom: 15px; font-size: 18px; }
    .product-detail-item { background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .product-detail-item h4 { margin-bottom: 8px; font-size: 16px; }
    .product-detail-item .info { display: flex; gap: 20px; margin-bottom: 10px; color: #7f8c8d; font-size: 14px; }
    .product-detail-item input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100px; }
    .product-detail-item .info + .info { margin-top: 8px; }
    .info-note { background: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; }
  </style>
</head>
<body>
  <header id="header" style="display: none;">
    <div class="container">
      <div class="logo">sative kitchen</div>
      <div class="user-info">
        <span class="role-badge" id="roleDisplay"></span>
        <button class="secondary" onclick="logout()">logout</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Login Page -->
    <div data-page="login">
      <div class="login-container">
        <h1>sative kitchen</h1>
        <p>select your role</p>
        
        <div id="roleButtons" style="display: grid; gap: 15px;">
          <button class="primary" style="width: 100%; padding: 15px; font-size: 16px;" onclick="selectRole('executor')">executor</button>
          <button class="primary" style="width: 100%; padding: 15px; font-size: 16px;" onclick="selectRole('manager')">manager</button>
          <button class="primary" style="width: 100%; padding: 15px; font-size: 16px;" onclick="selectRole('admin')">admin</button>
        </div>
        
        <div id="passwordPanel" style="display: none; margin-top: 30px;">
          <h3 id="selectedRoleName" style="font-size: 18px; margin-bottom: 15px; text-align: center;"></h3>
          <input type="password" id="rolePassword" placeholder="enter password" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; font-size: 14px;">
          <button class="primary" onclick="loginWithPassword()" style="width: 100%;">login</button>
          <button class="secondary" onclick="backToRoles()" style="width: 100%; margin-top: 10px;">← back</button>
        </div>
      </div>
    </div>

    <!-- Home Page -->
    <div data-page="home">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1>deliveries</h1>
        <button onclick="showNewDelivery()" id="newBtn">+ new delivery</button>
      </div>
      <div id="deliveriesList" class="loading">loading...</div>
    </div>

    <!-- New Delivery Page -->
    <div data-page="new-delivery">
      <h1>create delivery</h1>
      <button onclick="showPage('home')" class="secondary" style="margin-bottom: 20px;">← back</button>
      <div class="form-group">
        <label>date:</label>
        <input type="date" id="deliveryDate">
      </div>
      <h3 style="margin: 20px 0 10px;">products:</h3>
      <div id="productsForm" class="products-list"></div>
      <button onclick="saveDelivery()" style="width: 100%; margin-top: 20px;">save delivery</button>
    </div>

    <!-- Admin Page -->
    <div data-page="admin">
      <h1>admin panel</h1>
      <div style="display: flex; gap: 15px; margin: 30px 0;">
        <button onclick="showPage('admin-products')">manage products</button>
        <button class="secondary" onclick="showPage('admin-log')">audit log</button>
      </div>
    </div>

    <!-- Admin Products -->
    <div data-page="admin-products">
      <h1>manage products</h1>
      <button onclick="showPage('admin')" class="secondary" style="margin-bottom: 20px;">← back</button>
      <div id="adminProductsList" class="admin-products"></div>
    </div>

    <!-- Admin Log -->
    <div data-page="admin-log">
      <h1>audit log</h1>
      <button onclick="showPage('admin')" class="secondary" style="margin-bottom: 20px;">← back</button>
      <div id="auditLogList"></div>
    </div>

    <!-- Delivery Detail Page -->
    <div data-page="delivery-detail">
      <button onclick="showPage('home')" class="secondary" style="margin-bottom: 20px;">← back</button>
      <h1 id="deliveryDetailTitle">delivery details</h1>
      
      <div id="deliveryDetailSummary"></div>
      <h3 style="margin: 20px 0 10px;">products:</h3>
      <div id="deliveryEditNotice" class="info-note" style="display: none;"></div>
      <div id="deliveryDetailProducts"></div>

      <button onclick="saveDeliveryChanges()" id="saveChangesBtn" style="width: 100%; margin-top: 20px; display: none;">save changes</button>
    </div>
  </div>

  <script>
    // CONFIG
    const AUTH = { executor: '1234', manager: '5678', admin: '9999' };
    
    let currentUser = null;
    let currentRole = null;
    let allProducts = [];
    let allDeliveries = [];
    let currentDeliveryId = null;
    let currentDelivery = null;
    let hasChanges = false;
    let selectedRole = null;

    const TBILISI_TIMEZONE = 'Asia/Tbilisi';
    const tbilisiDateFormatter = new Intl.DateTimeFormat('en-CA', {
      timeZone: TBILISI_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });

    function parseTbilisiDate(value) {
      if (value === null || value === undefined) return null;

      if (value instanceof Date) {
        return Number.isNaN(value.getTime()) ? null : value;
      }

      if (typeof value === 'number') {
        const fromNumber = new Date(value);
        return Number.isNaN(fromNumber.getTime()) ? null : fromNumber;
      }

      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) return null;

        if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
          return new Date(`${trimmed}T00:00:00+04:00`);
        }

        const numeric = Number(trimmed);
        if (!Number.isNaN(numeric)) {
          return parseTbilisiDate(numeric);
        }

        const parsed = new Date(trimmed);
        return Number.isNaN(parsed.getTime()) ? null : parsed;
      }

      return null;
    }

    function normalizeDeliveryDate(value) {
      const parsed = parseTbilisiDate(value);
      if (!parsed) return '';
      return tbilisiDateFormatter.format(parsed);
    }

    function formatDate(value) {
      const normalized = normalizeDeliveryDate(value);
      return normalized || 'No date';
    }

    function normalizePaymentStatus(value) {
      if (value === null || value === undefined) {
        return 'unpaid';
      }

      const normalized = String(value).trim().toLowerCase();
      return normalized === 'paid' ? 'paid' : 'unpaid';
    }

    const round2 = value => Math.round((Number(value) || 0) * 100) / 100;

    const ensureNumber = value => {
      const number = Number(value);
      return Number.isFinite(number) ? number : 0;
    };

    const formatOneDecimal = value => ensureNumber(value).toFixed(1);

    function normalizeDeliveryRecord(raw) {
      if (!raw) return null;

      const base = Array.isArray(raw)
        ? {
            id: raw[0],
            date: raw[1],
            status: raw[2],
            payment_status: raw[3],
            total_cost: raw[4],
            total_sell: raw[5],
            margin: raw[6],
            created_by: raw[7],
            created_at: raw[8],
            updated_at: raw[9]
          }
        : { ...raw };

      const totalCost = ensureNumber(base.total_cost);
      const totalSell = ensureNumber(base.total_sell);

      return {
        ...base,
        id: Number(base.id) || base.id,
        payment_status: normalizePaymentStatus(base.payment_status),
        total_cost: totalCost,
        total_sell: totalSell,
        margin: ensureNumber(totalSell - totalCost)
      };
    }

    function normalizeProductRecord(raw) {
      if (!raw) return null;

      const base = Array.isArray(raw)
        ? {
            id: raw[0],
            name: raw[1],
            cost_price: raw[2],
            sell_price: raw[3],
            unit: raw[4],
            category: raw[5],
            active: raw[6]
          }
        : { ...raw };

      const activeValue = base.active;
      const isActive = activeValue === undefined
        ? true
        : String(activeValue).toLowerCase() === 'true';

      return {
        ...base,
        id: Number(base.id) || base.id,
        cost_price: ensureNumber(base.cost_price),
        sell_price: ensureNumber(base.sell_price),
        active: isActive
      };
    }

    function formatQuantity(value) {
      const number = Number(value) || 0;
      return Number.isInteger(number) ? number.toString() : number.toFixed(2);
    }

    function formatCurrency(value, digits = 2) {
      const number = Number(value) || 0;
      return number.toFixed(digits);
    }

    // API CALL
    async function apiCall(action, params = {}) {
      try {
        const url = new URL('/api/proxy', window.location.origin);
        url.searchParams.append('action', action);
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        
        const response = await fetch(url.toString());
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('API Error:', error);
        return { error: error.message };
      }
    }

    async function apiPost(action, data) {
      try {
        const response = await fetch('/api/proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, data })
        });
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('API Error:', error);
        return { error: error.message };
      }
    }

    // AUTH
    function selectRole(role) {
      selectedRole = role;
      document.getElementById('roleButtons').style.display = 'none';
      document.getElementById('passwordPanel').style.display = 'block';
      document.getElementById('selectedRoleName').textContent = role;
      document.getElementById('rolePassword').value = '';
      document.getElementById('rolePassword').focus();
    }

    function backToRoles() {
      selectedRole = null;
      document.getElementById('roleButtons').style.display = 'grid';
      document.getElementById('passwordPanel').style.display = 'none';
    }

    function loginWithPassword() {
      const pwd = document.getElementById('rolePassword').value;
      if (AUTH[selectedRole] === pwd) {
        currentUser = selectedRole;
        currentRole = selectedRole;
        sessionStorage.setItem('userRole', selectedRole);
        document.getElementById('header').style.display = 'block';
        document.getElementById('roleDisplay').textContent = selectedRole;
        
        if (selectedRole === 'admin') {
          showPage('admin');
        } else {
          showPage('home');
          loadDeliveries();
        }
      } else {
        alert('invalid password');
        document.getElementById('rolePassword').value = '';
      }
    }

    function logout() {
      currentUser = null;
      currentRole = null;
      sessionStorage.removeItem('userRole');
      document.getElementById('header').style.display = 'none';
      showPage('login');
    }

    // NAVIGATION
    function showPage(page) {
      document.querySelectorAll('[data-page]').forEach(el => el.style.display = 'none');
      const target = document.querySelector(`[data-page="${page}"]`);
      if (target) target.style.display = 'block';
      
      const newBtn = document.getElementById('newBtn');
      if (newBtn) newBtn.style.display = currentRole === 'manager' ? 'none' : 'block';
    }

    // LOAD DELIVERIES
    async function loadDeliveries() {
      document.getElementById('deliveriesList').innerHTML = '<div class="loading">loading...</div>';
      const result = await apiCall('getDeliveries');
      
      if (!result.success || !result.data || result.data.length === 0) {
        document.getElementById('deliveriesList').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">no deliveries yet</p>';
        return;
      }

      const deliveries = result.data
        .map(normalizeDeliveryRecord)
        .filter(Boolean)
        .map(delivery => ({
          ...delivery,
          date: normalizeDeliveryDate(delivery.date)
        }));

      allDeliveries = deliveries;

      const html = deliveries.slice().reverse().map(d => {
        const deliveryDate = formatDate(d.date);
        const paymentStatus = normalizePaymentStatus(d.payment_status);
        const isPaid = paymentStatus === 'paid';
        const showPaymentControls = currentRole === 'executor' || currentRole === 'manager';
        const totalCost = ensureNumber(d.total_cost);
        const totalSell = ensureNumber(d.total_sell);
        const marginValue = ensureNumber(d.margin);
        const displayMargin = Math.abs(marginValue) < 0.005 ? 0 : marginValue;
        const marginClass = marginValue < 0 ? 'metric-value margin-negative' : 'metric-value margin-positive';

        return `
        <div class="delivery-card">
          <div class="delivery-header">
            <div class="delivery-header-info" onclick="viewDelivery(${d.id})">
              <div class="delivery-date">${deliveryDate}</div>
              <span class="payment-badge ${isPaid ? 'paid' : 'unpaid'}">${paymentStatus}</span>
            </div>
            ${currentRole === 'executor' ? `
              <button class="button-compact secondary" onclick="event.stopPropagation(); deleteDelivery(${d.id})">delete</button>
            ` : ''}
          </div>
          <div class="delivery-metrics">
            <div class="metric">
              <div class="metric-label">cost price</div>
              <div class="metric-value">${formatCurrency(totalCost)}₾</div>
            </div>
            <div class="metric">
              <div class="metric-label">sell price</div>
              <div class="metric-value sell">${formatCurrency(totalSell)}₾</div>
            </div>
            <div class="metric">
              <div class="metric-label">margin</div>
              <div class="${marginClass}">${formatCurrency(displayMargin)}₾</div>
            </div>
          </div>
          ${showPaymentControls ? `
            <div class="delivery-actions-row">
              <div class="delivery-actions">
                <button class="action-button mark-paid" onclick="event.stopPropagation(); markDeliveryPaid(${d.id})" ${isPaid ? 'disabled' : ''}>mark as paid</button>
                <button class="action-button mark-unpaid" onclick="event.stopPropagation(); markDeliveryUnpaid(${d.id})" ${!isPaid ? 'disabled' : ''}>mark as unpaid</button>
              </div>
            </div>
          ` : ''}
        </div>
      `;
      }).join('');
      
      document.getElementById('deliveriesList').innerHTML = html;
    }

    // DELETE DELIVERY
    async function deleteDelivery(id) {
      if (!confirm('delete this delivery?')) return;

      const result = await apiPost('deleteDelivery', { id });

      if (result.success) {
        alert('delivery deleted');
        loadDeliveries();
      } else {
        alert('error: ' + (result.error || 'unknown'));
      }
    }

    async function updateDeliveryPaymentStatus(id, status) {
      const action = status === 'paid' ? 'markDeliveryPaid' : 'markDeliveryUnpaid';
      const result = await apiPost(action, { id });

      if (result.success) {
        if (Array.isArray(allDeliveries)) {
          const target = allDeliveries.find(d => Number(d.id) === Number(id));
          if (target) {
            target.payment_status = status;
          }
        }

        if (currentDelivery && Number(currentDelivery.id) === Number(id)) {
          currentDelivery.payment_status = status;
          renderDeliverySummary();
        }

        await loadDeliveries();
      } else {
        alert('error: ' + (result.error || 'unknown'));
      }
    }

    function markDeliveryPaid(id) {
      return updateDeliveryPaymentStatus(id, 'paid');
    }

    function markDeliveryUnpaid(id) {
      return updateDeliveryPaymentStatus(id, 'unpaid');
    }

    // VIEW DELIVERY DETAIL
    async function viewDelivery(id) {
      currentDeliveryId = id;
      hasChanges = false;
      showPage('delivery-detail');
      
      document.getElementById('deliveryDetailProducts').innerHTML = '<div class="loading">loading...</div>';
      
      const result = await apiCall('getDelivery', { id });
      
      if (!result.success || !result.data) {
        alert('error loading delivery');
        showPage('home');
        return;
      }
      
      const delivery = normalizeDeliveryRecord(result.data) || result.data;

      currentDelivery = {
        ...delivery,
        payment_status: normalizePaymentStatus(delivery.payment_status),
        date: normalizeDeliveryDate(delivery.date),
        items: (delivery.items || []).map(item => ({
          ...item,
          quantity: Number(item.quantity) || 0,
          cost_price: Number(item.cost_price) || 0,
          sell_price: Number(item.sell_price) || 0
        }))
      };

      const cleanDate = formatDate(currentDelivery.date);
      document.getElementById('deliveryDetailTitle').textContent = `Delivery ${cleanDate}`;

      const noticeEl = document.getElementById('deliveryEditNotice');
      if (noticeEl) {
        if (currentDelivery.status === 'completed') {
          noticeEl.textContent = 'editing of submitted deliveries is disabled. create a new delivery if updates are needed';
          noticeEl.style.display = 'block';
        } else {
          noticeEl.textContent = '';
          noticeEl.style.display = 'none';
        }
      }

      const canEdit = currentRole === 'executor' && currentDelivery.status !== 'completed';

      renderDeliverySummary();
      renderDeliveryItems(canEdit);
      document.getElementById('saveChangesBtn').style.display = canEdit ? 'block' : 'none';
    }

    function renderDeliverySummary() {
      if (!currentDelivery) return;

      const totals = currentDelivery.items.reduce((acc, item) => {
        const quantity = Number(item.quantity) || 0;
        const costPrice = Number(item.cost_price) || 0;
        const sellPrice = Number(item.sell_price) || 0;

        acc.totalCost += quantity * costPrice;
        acc.totalSell += quantity * sellPrice;
        return acc;
      }, { totalCost: 0, totalSell: 0 });

      totals.totalCost = round2(totals.totalCost);
      totals.totalSell = round2(totals.totalSell);
      const margin = round2(totals.totalSell - totals.totalCost);
      const paymentStatus = normalizePaymentStatus(currentDelivery.payment_status);
      const isPaid = paymentStatus === 'paid';
      const showPaymentControls = currentRole === 'executor' || currentRole === 'manager';
      const marginClass = margin < 0 ? 'margin-negative' : 'margin-positive';

      document.getElementById('deliveryDetailSummary').innerHTML = `
        <div class="detail-summary">
          <h3>Summary</h3>
          <div style="display: grid; grid-template-columns: ${currentRole === 'manager' ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)'}; gap: 15px;">
            <div>
              <span style="color: #7f8c8d; font-size: 12px;">cost price</span><br>
              <strong>${formatCurrency(totals.totalCost)}₾</strong>
            </div>
            <div>
              <span style="color: #7f8c8d; font-size: 12px;">sell price</span><br>
              <strong class="sell-positive">${formatCurrency(totals.totalSell)}₾</strong>
            </div>
            ${currentRole !== 'manager' ? `
            <div>
              <span style="color: #7f8c8d; font-size: 12px;">margin</span><br>
              <strong class="${marginClass}">${formatCurrency(margin)}₾</strong>
            </div>
            ` : ''}
          </div>
          <div class="delivery-payment" style="margin-top: 20px;">
            <span class="payment-status ${isPaid ? 'paid' : 'unpaid'}">payment: ${paymentStatus}</span>
            ${showPaymentControls ? `
              <div class="payment-actions">
                <button class="edit-btn" onclick="markDeliveryPaid(${currentDeliveryId})" ${isPaid ? 'disabled' : ''}>mark as paid</button>
                <button class="danger" onclick="markDeliveryUnpaid(${currentDeliveryId})" ${!isPaid ? 'disabled' : ''}>mark as unpaid</button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderDeliveryItems(canEdit) {
      if (!currentDelivery) return;

      const html = currentDelivery.items.map((item, index) => {
        const quantity = Number(item.quantity) || 0;
        const costPrice = Number(item.cost_price) || 0;
        const sellPrice = Number(item.sell_price) || 0;
        const totalCost = round2(quantity * costPrice);
        const totalSell = round2(quantity * sellPrice);

        return `
          <div class="product-detail-item" data-index="${index}">
            <h4>${item.product_name}</h4>
            <div class="info">
              <span>${item.unit}</span>
              <span>cost: ${formatCurrency(costPrice, 1)}₾</span>
              <span>sell: ${formatCurrency(sellPrice, 1)}₾</span>
            </div>
            <div class="info">
              ${canEdit ? `
                <label style="font-size: 13px; display: flex; flex-direction: column; gap: 4px;">
                  quantity:
                  <input type="number" step="0.5" min="0" value="${quantity}" data-index="${index}" oninput="updateDeliveryQuantity(${index}, this.value)" onchange="updateDeliveryQuantity(${index}, this.value)">
                </label>
              ` : `
                <span data-quantity-display="${index}">quantity: ${formatQuantity(quantity)}</span>
              `}
              <span>Total cost: <strong data-total-cost="${index}">${formatCurrency(totalCost)}</strong>₾</span>
              <span>Total sell: <strong data-total-sell="${index}">${formatCurrency(totalSell)}</strong>₾</span>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('deliveryDetailProducts').innerHTML = html;
    }

    function updateDeliveryQuantity(index, value) {
      if (!currentDelivery || currentDelivery.status === 'completed') return;

      const quantity = value === '' ? 0 : Math.max(0, parseFloat(value) || 0);
      if (!Number.isFinite(quantity)) return;

      currentDelivery.items[index].quantity = quantity;
      hasChanges = true;

      const costPrice = Number(currentDelivery.items[index].cost_price) || 0;
      const sellPrice = Number(currentDelivery.items[index].sell_price) || 0;

      const totalCost = round2(quantity * costPrice);
      const totalSell = round2(quantity * sellPrice);

      const costEl = document.querySelector(`[data-total-cost="${index}"]`);
      if (costEl) costEl.textContent = formatCurrency(totalCost);

      const sellEl = document.querySelector(`[data-total-sell="${index}"]`);
      if (sellEl) sellEl.textContent = formatCurrency(totalSell);

      const quantityDisplay = document.querySelector(`[data-quantity-display="${index}"]`);
      if (quantityDisplay) {
        quantityDisplay.textContent = `quantity: ${formatQuantity(quantity)}`;
      }

      renderDeliverySummary();
    }

    async function saveDeliveryChanges() {
      if (!currentDelivery || currentDelivery.status === 'completed') {
        return;
      }

      if (!hasChanges) {
        alert('no changes to save');
        return;
      }

      const items = currentDelivery.items.map(item => ({
        id: parseInt(item.id, 10),
        quantity: Number(item.quantity) || 0
      }));

      const result = await apiPost('updateDelivery', {
        id: currentDeliveryId,
        items
      });

      if (result.success) {
        alert('changes saved!');
        hasChanges = false;
        await viewDelivery(currentDeliveryId);
        if (typeof loadDeliveries === 'function') {
          loadDeliveries();
        }
      } else {
        alert('error: ' + (result.error || 'unknown'));
      }
    }

    // LOAD PRODUCTS FOR FORM
    async function showNewDelivery() {
      showPage('new-delivery');
      const dateInput = document.getElementById('deliveryDate');
      if (dateInput) {
        const normalizedValue = normalizeDeliveryDate(dateInput.value);
        dateInput.value = normalizedValue || normalizeDeliveryDate(new Date());
      }
      document.getElementById('productsForm').innerHTML = '<div class="loading">loading products...</div>';
      
      const result = await apiCall('getProducts');

      if (!result.success || !result.data) {
        document.getElementById('productsForm').innerHTML = '<p>error loading products</p>';
        return;
      }

      allProducts = result.data
        .map(normalizeProductRecord)
        .filter(p => p && p.active);

      const html = allProducts.map(p => `
        <div class="product-item" data-id="${p.id}">
          <div><strong>${p.name}</strong><br><small>${p.unit}</small></div>
          <div>
            <small>cost</small><br>
            <span>${formatOneDecimal(p.cost_price)}₾</span>
          </div>
          <div>
            <small>sell</small><br>
            <span>${formatOneDecimal(p.sell_price)}₾</span>
          </div>
          <input type="number" step="0.5" min="0" value="0" placeholder="qty" data-product="${p.id}">
        </div>
      `).join('');
      
      document.getElementById('productsForm').innerHTML = html;
    }

    // SAVE DELIVERY
    async function saveDelivery() {
      const dateInput = document.getElementById('deliveryDate');
      const rawDate = dateInput ? dateInput.value : '';
      const date = normalizeDeliveryDate(rawDate);

      if (!date) {
        alert('select delivery date');
        return;
      }

      const items = [];
      document.querySelectorAll('.product-item').forEach(row => {
        const qty = parseFloat(row.querySelector('input').value) || 0;
        if (qty > 0) {
          const productId = parseInt(row.dataset.id);
          const product = allProducts.find(p => p.id === productId);
          if (product) {
            items.push({
              product_id: productId,
              quantity: qty,
              cost_price: ensureNumber(product.cost_price),
              sell_price: ensureNumber(product.sell_price)
            });
          }
        }
      });
      
      if (items.length === 0) {
        alert('add at least one product');
        return;
      }
      
      const result = await apiPost('createDelivery', {
        date: date,
        items: items,
        created_by: currentUser,
        payment_status: 'unpaid'
      });
      
      if (result.success) {
        alert('delivery created!');
        showPage('home');
        loadDeliveries();
      } else {
        alert('error: ' + (result.error || 'unknown'));
      }
    }

    // ADMIN - LOAD PRODUCTS
    async function loadAdminProducts() {
      document.getElementById('adminProductsList').innerHTML = '<div class="loading">loading...</div>';
      const result = await apiCall('getProducts');
      
      if (!result.success || !result.data) {
        document.getElementById('adminProductsList').innerHTML = '<p>error loading</p>';
        return;
      }
      
      const html = result.data.filter(p => p.active).map(p => `
        <div class="product-row">
          <div class="product-name">${p.name} (${p.unit})</div>
          <div class="product-prices">
            <input type="number" step="0.1" value="${p.cost_price || 0}" 
                   onchange="updateProductPrice(${p.id}, 'cost_price', this.value)"
                   placeholder="cost">
            <input type="number" step="0.1" value="${p.sell_price || 0}"
                   onchange="updateProductPrice(${p.id}, 'sell_price', this.value)"
                   placeholder="sell">
          </div>
        </div>
      `).join('');
      
      document.getElementById('adminProductsList').innerHTML = html;
    }

    // UPDATE PRODUCT
    async function updateProductPrice(id, field, value) {
      const result = await apiCall('getProducts');
      if (!result.success) return;
      
      const product = result.data.find(p => p.id === id);
      if (!product) return;
      
      product[field] = parseFloat(value) || 0;
      
      await apiPost('updateProduct', product);
      alert('price updated');
    }

    // LOAD AUDIT LOG
    async function loadAuditLog() {
      document.getElementById('auditLogList').innerHTML = '<div class="loading">loading...</div>';
      const result = await apiCall('getAuditLog');
      
      if (!result.success || !result.data || result.data.length === 0) {
        document.getElementById('auditLogList').innerHTML = '<p>no logs</p>';
        return;
      }
      
      const html = result.data.reverse().slice(0, 50).map(log => `
        <div style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 6px; font-size: 13px;">
          <strong>${log.timestamp}</strong> | ${log.user} | ${log.action} | ${log.entity} #${log.entity_id}
          <br><small style="color: #7f8c8d;">${log.details}</small>
        </div>
      `).join('');
      
      document.getElementById('auditLogList').innerHTML = html;
    }

    // INIT
    window.addEventListener('DOMContentLoaded', () => {
      // Auto-login from sessionStorage
      const savedRole = sessionStorage.getItem('userRole');
      if (savedRole && AUTH[savedRole]) {
        currentUser = savedRole;
        currentRole = savedRole;
        document.getElementById('header').style.display = 'block';
        document.getElementById('roleDisplay').textContent = savedRole;
        
        if (savedRole === 'admin') {
          showPage('admin');
        } else {
          showPage('home');
          loadDeliveries();
        }
      } else {
        showPage('login');
      }
      
      const dateInput = document.getElementById('deliveryDate');
      if (dateInput) {
        const normalizedValue = normalizeDeliveryDate(dateInput.value);
        dateInput.value = normalizedValue || normalizeDeliveryDate(new Date());
      }
      
      // Admin page load handlers
      const observer = new MutationObserver(() => {
        const adminProducts = document.querySelector('[data-page="admin-products"]');
        const adminLog = document.querySelector('[data-page="admin-log"]');
        
        if (adminProducts && adminProducts.style.display === 'block' && !adminProducts.dataset.loaded) {
          adminProducts.dataset.loaded = 'true';
          loadAdminProducts();
        }
        
        if (adminLog && adminLog.style.display === 'block' && !adminLog.dataset.loaded) {
          adminLog.dataset.loaded = 'true';
          loadAuditLog();
        }
      });
      
      observer.observe(document.body, { attributes: true, subtree: true, attributeFilter: ['style'] });
    });
  </script>

  <!-- Manager Page -->
  <div data-page="manager">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
      <h1>manager dashboard</h1>
      <button onclick="showNewDelivery()" id="newBtn">+ new delivery</button>
    </div>
    <div id="deliveriesList" class="loading">loading...</div>
  </div>

</body>
</html>
