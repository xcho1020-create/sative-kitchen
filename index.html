<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sative Kitchen</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f9fa; color: #2c3e50; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    header { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; }
    header .container { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
    .logo { font-size: 24px; font-weight: 700; color: #2c3e50; }
    .user-info { display: flex; align-items: center; gap: 15px; font-size: 14px; }
    .role-badge { background: #e8f4f8; color: #1a7f8f; padding: 6px 12px; border-radius: 20px; font-weight: 600; }
    button { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; }
    button:hover { background: #1a252f; }
    button.secondary { background: #95a5a6; }
    button.secondary:hover { background: #7f8c8d; }
    button.primary { background: #1a7f8f; }
    button.primary:hover { background: #156873; }
    button.danger { background: #e74c3c; padding: 6px 12px; font-size: 13px; }
    button.danger:hover { background: #c0392b; }
    button.edit-btn { background: #3498db; padding: 6px 12px; font-size: 13px; }
    button.edit-btn:hover { background: #2980b9; }
    [data-page] { display: none; }
    .login-container { max-width: 400px; margin: 60px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .login-container h1 { font-size: 28px; margin-bottom: 10px; text-align: center; }
    .login-container p { text-align: center; margin-bottom: 30px; color: #7f8c8d; font-size: 14px; }
    .delivery-card { background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .delivery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .delivery-date { font-weight: 600; font-size: 16px; cursor: pointer; color: #1a7f8f; }
    .delivery-date:hover { text-decoration: underline; }
    .delivery-actions { display: flex; gap: 8px; }
    .delivery-payment { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; gap: 12px; flex-wrap: wrap; }
    .payment-status { font-weight: 600; text-transform: capitalize; }
    .payment-status.paid { color: #27ae60; }
    .payment-status.unpaid { color: #e74c3c; }
    .payment-actions { display: flex; gap: 8px; }
    .payment-actions button { padding: 6px 12px; font-size: 13px; }
    .delivery-totals { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; font-size: 14px; }
    .delivery-totals div { display: flex; flex-direction: column; }
    .delivery-totals span:first-child { color: #7f8c8d; font-size: 12px; margin-bottom: 2px; }
    .delivery-totals span:last-child { font-weight: 600; }
    .margin-positive { color: #27ae60; }
    .sell-positive { color: #27ae60; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
    .products-list { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; max-height: 400px; overflow-y: auto; }
    .product-item { background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: center; }
    .product-item input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
    .admin-products .product-row { background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .admin-products .product-name { flex: 1; font-weight: 500; }
    .admin-products .product-prices { display: flex; gap: 10px; }
    .admin-products .product-prices input { width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    .detail-summary { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .detail-summary h3 { margin-bottom: 15px; font-size: 18px; }
    .product-detail-item { background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .product-detail-item h4 { margin-bottom: 8px; font-size: 16px; }
    .product-detail-item .info { display: flex; gap: 20px; margin-bottom: 10px; color: #7f8c8d; font-size: 14px; }
    .product-detail-item input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100px; }
    .product-detail-item .info + .info { margin-top: 8px; }
    .info-note { background: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; }
  </style>
</head>
<body>
  <header id="header" style="display: none;">
    <div class="container">
      <div class="logo">sative kitchen</div>
      <div class="user-info">
        <span class="role-badge" id="roleDisplay"></span>
        <button class="secondary" onclick="logout()">logout</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Login Page -->
    <div data-page="login">
      <div class="login-container">
        <h1>sative kitchen</h1>
        <p>select your role</p>
        
        <div id="roleButtons" style="display: grid; gap: 15px;">
          <button class="primary" style="width: 100%; padding: 15px; font-size: 16px;" onclick="selectRole('executor')">executor</button>
          <button class="primary" style="width: 100%; padding: 15px; font-size: 16px;" onclick="selectRole('manager')">manager</button>
          <button class="primary" style="width: 100%; padding: 15px; font-size: 16px;" onclick="selectRole('admin')">admin</button>
        </div>
        
        <div id="passwordPanel" style="display: none; margin-top: 30px;">
          <h3 id="selectedRoleName" style="font-size: 18px; margin-bottom: 15px; text-align: center;"></h3>
          <input type="password" id="rolePassword" placeholder="enter password" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; font-size: 14px;">
          <button class="primary" onclick="loginWithPassword()" style="width: 100%;">login</button>
          <button class="secondary" onclick="backToRoles()" style="width: 100%; margin-top: 10px;">← back</button>
        </div>
      </div>
    </div>

    <!-- Home Page -->
    <div data-page="home">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1>deliveries</h1>
        <button onclick="showNewDelivery()" id="newBtn">+ new delivery</button>
      </div>
      <div id="deliveriesList" class="loading">loading...</div>
    </div>

    <!-- New Delivery Page -->
    <div data-page="new-delivery">
      <h1>create delivery</h1>
      <button onclick="showPage('home')" class="secondary" style="margin-bottom: 20px;">← back</button>
      <div class="form-group">
        <label>date:</label>
        <input type="date" id="deliveryDate">
      </div>
      <h3 style="margin: 20px 0 10px;">products:</h3>
      <div id="productsForm" class="products-list"></div>
      <button onclick="saveDelivery()" style="width: 100%; margin-top: 20px;">save delivery</button>
    </div>

    <!-- Admin Page -->
    <div data-page="admin">
      <h1>admin panel</h1>
      <div style="display: flex; gap: 15px; margin: 30px 0;">
        <button onclick="showPage('admin-products')">manage products</button>
        <button class="secondary" onclick="showPage('admin-log')">audit log</button>
      </div>
    </div>

    <!-- Admin Products -->
    <div data-page="admin-products">
      <h1>manage products</h1>
      <button onclick="showPage('admin')" class="secondary" style="margin-bottom: 20px;">← back</button>
      <div id="adminProductsList" class="admin-products"></div>
    </div>

    <!-- Admin Log -->
    <div data-page="admin-log">
      <h1>audit log</h1>
      <button onclick="showPage('admin')" class="secondary" style="margin-bottom: 20px;">← back</button>
      <div id="auditLogList"></div>
    </div>

    <!-- Delivery Detail Page -->
    <div data-page="delivery-detail">
      <button onclick="showPage('home')" class="secondary" style="margin-bottom: 20px;">← back</button>
      <h1 id="deliveryDetailTitle">delivery details</h1>
      
      <div id="deliveryDetailSummary"></div>
      <h3 style="margin: 20px 0 10px;">products:</h3>
      <div id="deliveryEditNotice" class="info-note" style="display: none;"></div>
      <div id="deliveryDetailProducts"></div>

      <button onclick="saveDeliveryChanges()" id="saveChangesBtn" style="width: 100%; margin-top: 20px; display: none;">save changes</button>
    </div>
  </div>

  <script>
    // ============================================================================
    // CONFIGURATION & STATE
    // ============================================================================
    
    // Authentication credentials (change these in production)
    const AUTH = { executor: '1234', manager: '5678', admin: '9999' };
    
    // Application state
    let currentUser = null;
    let currentRole = null;
    let allProducts = [];
    let allDeliveries = [];
    let currentDeliveryId = null;
    let currentDelivery = null;
    let hasChanges = false;
    let selectedRole = null;

    // ============================================================================
    // DATE FORMATTING (Asia/Tbilisi timezone)
    // ============================================================================
    
    const TBILISI_TIMEZONE = 'Asia/Tbilisi';

    // Date formatter for date-only fields (yyyy-MM-dd)
    const dateOnlyFormatter = new Intl.DateTimeFormat('en-CA', {
      timeZone: TBILISI_TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });

    // DateTime formatter for ISO timestamps (created_at, updated_at)
    const dateTimeFormatter = new Intl.DateTimeFormat('en-GB', {
      dateStyle: 'medium',
      timeStyle: 'short',
      timeZone: TBILISI_TIMEZONE
    });

    /**
     * Format a date value (handles yyyy-MM-dd strings or ISO timestamps)
     * Returns formatted date string in yyyy-MM-dd format
     */
    function formatDate(value) {
      if (!value) return 'No date';
      
      try {
        // If already in yyyy-MM-dd format, parse and format to ensure consistency
        if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value.trim())) {
          return value.trim();
        }
        
        // Parse ISO string or any date format
        const date = new Date(value);
        if (isNaN(date.getTime())) return 'Invalid date';
        
        return dateOnlyFormatter.format(date);
      } catch (e) {
        return 'Invalid date';
      }
    }

    /**
     * Format ISO datetime string to localized date + time
     * For created_at, updated_at fields that include time component
     */
    function formatDateTime(value) {
      if (!value) return '';
      
      try {
        const date = new Date(value);
        if (isNaN(date.getTime())) return '';
        
        return dateTimeFormatter.format(date);
      } catch (e) {
        return '';
      }
    }

    /**
     * Normalize date for form input (yyyy-MM-dd format)
     */
    function normalizeDeliveryDate(value) {
      if (!value) return '';
      
      try {
        if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value.trim())) {
          return value.trim();
        }
        
        const date = new Date(value);
        if (isNaN(date.getTime())) return '';
        
        return dateOnlyFormatter.format(date);
      } catch (e) {
        return '';
      }
    }

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    /**
     * Normalize payment status to 'paid' or 'unpaid'
     */
    function normalizePaymentStatus(value) {
      if (value === null || value === undefined) {
        return 'unpaid';
      }

      const normalized = String(value).trim().toLowerCase();
      return normalized === 'paid' ? 'paid' : 'unpaid';
    }

    /**
     * Round number to 2 decimal places
     */
    const round2 = value => Math.round((Number(value) || 0) * 100) / 100;

    /**
     * Safely convert value to number, returning 0 if invalid
     */
    const ensureNumber = value => {
      const number = Number(value);
      return Number.isFinite(number) ? number : 0;
    };

    /**
     * Format quantity (integer or decimal)
     */
    function formatQuantity(value) {
      const number = Number(value) || 0;
      return Number.isInteger(number) ? number.toString() : number.toFixed(2);
    }

    /**
     * Format currency value with GEL symbol
     */
    function formatCurrency(value, digits = 2) {
      const number = Number(value) || 0;
      return number.toFixed(digits);
    }

    /**
     * Robust money formatter that handles strings with spaces/commas
     * @param {*} v - Value to format (can be string or number)
     * @returns {string} - Formatted string with ₾ symbol
     */
    function formatMoney(v) {
      if (typeof v === 'string') {
        v = Number(v.replace(/\s/g, '').replace(',', '.'));
      }
      v = Number(v);
      return Number.isFinite(v) ? v.toFixed(2) + '₾' : '0.00₾';
    }

    // ============================================================================
    // API LAYER
    // ============================================================================
    
    // Centralized API base URL - change this to point to your backend
    const API_BASE_URL = '/api/proxy';

    /**
     * Generic fetch wrapper with retry logic.
     * Retries once on network failure before returning error.
     * 
     * @param {string} url - The URL to fetch
     * @param {object} options - Fetch options (method, headers, body, etc.)
     * @param {number} retries - Number of retries remaining (default: 1)
     * @returns {Promise<object>} - JSON response or error object
     */
    async function apiFetch(url, options = {}, retries = 1) {
      try {
        const response = await fetch(url, options);
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('API Error:', error);
        
        // Retry once on network failure
        if (retries > 0) {
          console.log(`Retrying API call (${retries} retries left)...`);
          await new Promise(resolve => setTimeout(resolve, 500)); // Wait 500ms before retry
          return apiFetch(url, options, retries - 1);
        }
        
        return { success: false, error: error.message };
      }
    }

    /**
     * GET request with query parameters
     * 
     * @param {string} action - API action name
     * @param {object} params - Query parameters
     * @returns {Promise<object>} - API response
     */
    async function apiCall(action, params = {}) {
      const url = new URL(API_BASE_URL, window.location.origin);
      url.searchParams.append('action', action);
      Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
      
      return apiFetch(url.toString());
    }

    /**
     * POST request with JSON body
     * 
     * @param {string} action - API action name
     * @param {object} data - Request body data
     * @returns {Promise<object>} - API response
     */
    async function apiPost(action, data) {
      return apiFetch(API_BASE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, data })
      });
    }

    // AUTH
    function selectRole(role) {
      selectedRole = role;
      document.getElementById('roleButtons').style.display = 'none';
      document.getElementById('passwordPanel').style.display = 'block';
      document.getElementById('selectedRoleName').textContent = role;
      document.getElementById('rolePassword').value = '';
      document.getElementById('rolePassword').focus();
    }

    function backToRoles() {
      selectedRole = null;
      document.getElementById('roleButtons').style.display = 'grid';
      document.getElementById('passwordPanel').style.display = 'none';
    }

    function loginWithPassword() {
      const pwd = document.getElementById('rolePassword').value;
      if (AUTH[selectedRole] === pwd) {
        currentUser = selectedRole;
        currentRole = selectedRole;
        sessionStorage.setItem('userRole', selectedRole);
        document.getElementById('header').style.display = 'block';
        document.getElementById('roleDisplay').textContent = selectedRole;
        
        if (selectedRole === 'admin') {
          showPage('admin');
        } else {
          showPage('home');
          loadDeliveries();
        }
      } else {
        alert('invalid password');
        document.getElementById('rolePassword').value = '';
      }
    }

    function logout() {
      currentUser = null;
      currentRole = null;
      sessionStorage.removeItem('userRole');
      document.getElementById('header').style.display = 'none';
      showPage('login');
    }

    // NAVIGATION
    function showPage(page) {
      document.querySelectorAll('[data-page]').forEach(el => el.style.display = 'none');
      const target = document.querySelector(`[data-page="${page}"]`);
      if (target) target.style.display = 'block';
      
      const newBtn = document.getElementById('newBtn');
      if (newBtn) newBtn.style.display = currentRole === 'manager' ? 'none' : 'block';
    }

    // LOAD DELIVERIES
    async function loadDeliveries() {
      document.getElementById('deliveriesList').innerHTML = '<div class="loading">loading...</div>';
      const result = await apiCall('getDeliveries');
      
      if (!result.success || !result.data || result.data.length === 0) {
        document.getElementById('deliveriesList').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">no deliveries yet</p>';
        return;
      }

      const deliveries = result.data.map(delivery => ({
        ...delivery,
        date: normalizeDeliveryDate(delivery.date),
        payment_status: normalizePaymentStatus(delivery.payment_status),
        // Use total_cost from backend, fallback to cost_price (legacy), then 0
        total_cost: Number(delivery.total_cost ?? delivery.cost_price ?? 0),
        total_sell: Number(delivery.total_sell ?? delivery.sell_price ?? 0),
        margin: Number(delivery.margin ?? 0)
      }));

      allDeliveries = deliveries;

      // Sort deliveries by created_at (or date) descending, not by ID
      const sortedDeliveries = deliveries.slice().sort((a, b) => {
        const dateA = a.created_at || a.date || '';
        const dateB = b.created_at || b.date || '';
        return dateB.localeCompare(dateA);
      });

      const html = sortedDeliveries.map(d => {
        const deliveryDate = formatDate(d.date);
        const paymentStatus = normalizePaymentStatus(d.payment_status);
        const isPaid = paymentStatus === 'paid';
        const showPaymentControls = currentRole === 'executor' || currentRole === 'manager';

        return `
        <div class="delivery-card">
          <div class="delivery-header">
            <div class="delivery-date" onclick="viewDelivery('${d.id}')">${deliveryDate}</div>
            ${currentRole === 'executor' ? `
              <div class="delivery-actions">
                <button class="danger" onclick="event.stopPropagation(); deleteDelivery('${d.id}')">delete</button>
              </div>
            ` : ''}
          </div>
          <div class="delivery-totals">
            <div>
              <span>cost price</span>
              <span>${formatMoney(d.total_cost)}</span>
            </div>
            <div>
              <span>sell price</span>
              <span class="sell-positive">${formatMoney(d.total_sell)}</span>
            </div>
            ${currentRole !== 'manager' ? `
            <div>
              <span>margin</span>
              <span class="margin-positive">${formatMoney(d.margin)}</span>
            </div>
            ` : ''}
          </div>
          <div class="delivery-payment">
            <span class="payment-status ${isPaid ? 'paid' : 'unpaid'}">payment: ${paymentStatus}</span>
            ${showPaymentControls ? `
              <div class="payment-actions">
                <button class="edit-btn" onclick="event.stopPropagation(); markDeliveryPaid('${d.id}')" ${isPaid ? 'disabled' : ''}>mark as paid</button>
                <button class="danger" onclick="event.stopPropagation(); markDeliveryUnpaid('${d.id}')" ${!isPaid ? 'disabled' : ''}>mark as unpaid</button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
      }).join('');
      
      document.getElementById('deliveriesList').innerHTML = html;
    }

    // DELETE DELIVERY
    async function deleteDelivery(id) {
      if (!confirm('delete this delivery?')) return;

      const result = await apiPost('deleteDelivery', { id });

      if (result.success) {
        alert('delivery deleted');
        loadDeliveries();
      } else {
        alert('error: ' + (result.error || 'unknown'));
      }
    }

    async function updateDeliveryPaymentStatus(id, status) {
      const action = status === 'paid' ? 'markDeliveryPaid' : 'markDeliveryUnpaid';
      const result = await apiPost(action, { id });

      if (result.success) {
        if (Array.isArray(allDeliveries)) {
          const target = allDeliveries.find(d => String(d.id) === String(id));
          if (target) {
            target.payment_status = status;
          }
        }

        if (currentDelivery && String(currentDelivery.id) === String(id)) {
          currentDelivery.payment_status = status;
          renderDeliverySummary();
        }

        await loadDeliveries();
      } else {
        alert('error: ' + (result.error || 'unknown'));
      }
    }

    function markDeliveryPaid(id) {
      return updateDeliveryPaymentStatus(id, 'paid');
    }

    function markDeliveryUnpaid(id) {
      return updateDeliveryPaymentStatus(id, 'unpaid');
    }

    // VIEW DELIVERY DETAIL
    async function viewDelivery(id) {
      currentDeliveryId = id;
      hasChanges = false;
      showPage('delivery-detail');
      
      document.getElementById('deliveryDetailProducts').innerHTML = '<div class="loading">loading...</div>';
      
      const result = await apiCall('getDelivery', { id });
      
      if (!result.success || !result.data) {
        alert('error loading delivery');
        showPage('home');
        return;
      }
      
      const delivery = result.data;

      currentDelivery = {
        ...delivery,
        payment_status: normalizePaymentStatus(delivery.payment_status),
        date: normalizeDeliveryDate(delivery.date),
        items: (delivery.items || []).map(item => ({
          ...item,
          quantity: Number(item.quantity) || 0,
          cost_price: Number(item.cost_price) || 0,
          sell_price: Number(item.sell_price) || 0
        }))
      };

      const cleanDate = formatDate(currentDelivery.date);
      document.getElementById('deliveryDetailTitle').textContent = `Delivery ${cleanDate}`;

      const noticeEl = document.getElementById('deliveryEditNotice');
      if (noticeEl) {
        if (currentDelivery.status === 'completed') {
          noticeEl.textContent = 'editing of submitted deliveries is disabled. create a new delivery if updates are needed';
          noticeEl.style.display = 'block';
        } else {
          noticeEl.textContent = '';
          noticeEl.style.display = 'none';
        }
      }

      const canEdit = currentRole === 'executor' && currentDelivery.status !== 'completed';

      renderDeliverySummary();
      renderDeliveryItems(canEdit);
      document.getElementById('saveChangesBtn').style.display = canEdit ? 'block' : 'none';
    }

    function renderDeliverySummary() {
      if (!currentDelivery) return;

      const totals = currentDelivery.items.reduce((acc, item) => {
        const quantity = Number(item.quantity) || 0;
        const costPrice = Number(item.cost_price) || 0;
        const sellPrice = Number(item.sell_price) || 0;

        acc.totalCost += quantity * costPrice;
        acc.totalSell += quantity * sellPrice;
        return acc;
      }, { totalCost: 0, totalSell: 0 });

      totals.totalCost = round2(totals.totalCost);
      totals.totalSell = round2(totals.totalSell);
      const margin = round2(totals.totalSell - totals.totalCost);
      const paymentStatus = normalizePaymentStatus(currentDelivery.payment_status);
      const isPaid = paymentStatus === 'paid';
      const showPaymentControls = currentRole === 'executor' || currentRole === 'manager';

      const createdAt = formatDateTime(currentDelivery.created_at);
      const updatedAt = formatDateTime(currentDelivery.updated_at);
      const createdBy = currentDelivery.created_by || '';
      const updatedBy = currentDelivery.updated_by || '';

      document.getElementById('deliveryDetailSummary').innerHTML = `
        <div class="detail-summary">
          <h3>Summary</h3>
          <div style="display: grid; grid-template-columns: ${currentRole === 'manager' ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)'}; gap: 15px;">
            <div>
              <span style="color: #7f8c8d; font-size: 12px;">cost price</span><br>
              <strong>${formatCurrency(totals.totalCost)}₾</strong>
            </div>
            <div>
              <span style="color: #7f8c8d; font-size: 12px;">sell price</span><br>
              <strong class="sell-positive">${formatCurrency(totals.totalSell)}₾</strong>
            </div>
            ${currentRole !== 'manager' ? `
            <div>
              <span style="color: #7f8c8d; font-size: 12px;">margin</span><br>
              <strong class="margin-positive">${formatCurrency(margin)}₾</strong>
            </div>
            ` : ''}
          </div>
          ${createdAt ? `
            <div style="margin-top: 15px; font-size: 13px; color: #7f8c8d;">
              <div>Created: ${createdAt}${createdBy ? ` by ${createdBy}` : ''}</div>
              ${updatedAt ? `<div style="margin-top: 4px;">Updated: ${updatedAt}${updatedBy ? ` by ${updatedBy}` : ''}</div>` : ''}
            </div>
          ` : ''}
          <div class="delivery-payment" style="margin-top: 20px;">
            <span class="payment-status ${isPaid ? 'paid' : 'unpaid'}">payment: ${paymentStatus}</span>
            ${showPaymentControls ? `
              <div class="payment-actions">
                <button class="edit-btn" onclick="markDeliveryPaid('${currentDeliveryId}')" ${isPaid ? 'disabled' : ''}>mark as paid</button>
                <button class="danger" onclick="markDeliveryUnpaid('${currentDeliveryId}')" ${!isPaid ? 'disabled' : ''}>mark as unpaid</button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderDeliveryItems(canEdit) {
      if (!currentDelivery) return;

      const html = currentDelivery.items.map((item, index) => {
        const quantity = Number(item.quantity) || 0;
        const costPrice = Number(item.cost_price) || 0;
        const sellPrice = Number(item.sell_price) || 0;
        const totalCost = round2(quantity * costPrice);
        const totalSell = round2(quantity * sellPrice);

        return `
          <div class="product-detail-item" data-index="${index}">
            <h4>${item.product_name}</h4>
            <div class="info">
              <span>${item.unit}</span>
              <span>cost: ${formatCurrency(costPrice, 1)}₾</span>
              <span>sell: ${formatCurrency(sellPrice, 1)}₾</span>
            </div>
            <div class="info">
              ${canEdit ? `
                <label style="font-size: 13px; display: flex; flex-direction: column; gap: 4px;">
                  quantity:
                  <input type="number" step="0.5" min="0" value="${quantity}" data-index="${index}" oninput="updateDeliveryQuantity(${index}, this.value)" onchange="updateDeliveryQuantity(${index}, this.value)">
                </label>
              ` : `
                <span data-quantity-display="${index}">quantity: ${formatQuantity(quantity)}</span>
              `}
              <span>Total cost: <strong data-total-cost="${index}">${formatCurrency(totalCost)}</strong>₾</span>
              <span>Total sell: <strong data-total-sell="${index}">${formatCurrency(totalSell)}</strong>₾</span>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('deliveryDetailProducts').innerHTML = html;
    }

    function updateDeliveryQuantity(index, value) {
      if (!currentDelivery || currentDelivery.status === 'completed') return;

      const quantity = value === '' ? 0 : Math.max(0, parseFloat(value) || 0);
      if (!Number.isFinite(quantity)) return;

      currentDelivery.items[index].quantity = quantity;
      hasChanges = true;

      const costPrice = Number(currentDelivery.items[index].cost_price) || 0;
      const sellPrice = Number(currentDelivery.items[index].sell_price) || 0;

      const totalCost = round2(quantity * costPrice);
      const totalSell = round2(quantity * sellPrice);

      const costEl = document.querySelector(`[data-total-cost="${index}"]`);
      if (costEl) costEl.textContent = formatCurrency(totalCost);

      const sellEl = document.querySelector(`[data-total-sell="${index}"]`);
      if (sellEl) sellEl.textContent = formatCurrency(totalSell);

      const quantityDisplay = document.querySelector(`[data-quantity-display="${index}"]`);
      if (quantityDisplay) {
        quantityDisplay.textContent = `quantity: ${formatQuantity(quantity)}`;
      }

      renderDeliverySummary();
    }

    async function saveDeliveryChanges() {
      if (!currentDelivery || currentDelivery.status === 'completed') {
        return;
      }

      if (!hasChanges) {
        alert('no changes to save');
        return;
      }

      const items = currentDelivery.items.map(item => ({
        id: item.id,
        quantity: Number(item.quantity) || 0
      }));

      const result = await apiPost('updateDelivery', {
        id: currentDeliveryId,
        items
      });

      if (result.success) {
        alert('changes saved!');
        hasChanges = false;
        await viewDelivery(currentDeliveryId);
        if (typeof loadDeliveries === 'function') {
          loadDeliveries();
        }
      } else {
        alert('error: ' + (result.error || 'unknown'));
      }
    }

    // LOAD PRODUCTS FOR FORM
    async function showNewDelivery() {
      showPage('new-delivery');
      const dateInput = document.getElementById('deliveryDate');
      if (dateInput) {
        const normalizedValue = normalizeDeliveryDate(dateInput.value);
        dateInput.value = normalizedValue || normalizeDeliveryDate(new Date());
      }
      document.getElementById('productsForm').innerHTML = '<div class="loading">loading products...</div>';
      
      const result = await apiCall('getProducts');
      
      if (!result.success || !result.data) {
        document.getElementById('productsForm').innerHTML = '<p>error loading products</p>';
        return;
      }
      
      allProducts = result.data.filter(p => p.active);
      
      const html = allProducts.map(p => `
        <div class="product-item" data-id="${p.id}">
          <div><strong>${p.name}</strong><br><small>${p.unit}</small></div>
          <div>
            <small>cost</small><br>
            <span>${(p.cost_price || 0).toFixed(1)}₾</span>
          </div>
          <div>
            <small>sell</small><br>
            <span>${(p.sell_price || 0).toFixed(1)}₾</span>
          </div>
          <input type="number" step="0.5" min="0" value="0" placeholder="qty" data-product="${p.id}">
        </div>
      `).join('');
      
      document.getElementById('productsForm').innerHTML = html;
    }

    // SAVE DELIVERY
    async function saveDelivery() {
      const dateInput = document.getElementById('deliveryDate');
      const rawDate = dateInput ? dateInput.value : '';
      const date = normalizeDeliveryDate(rawDate);

      if (!date) {
        alert('select delivery date');
        return;
      }

      const items = [];
      document.querySelectorAll('.product-item').forEach(row => {
        const qty = parseFloat(row.querySelector('input').value) || 0;
        if (qty > 0) {
          const productId = row.dataset.id;
          const product = allProducts.find(p => String(p.id) === String(productId));
          if (product) {
            items.push({
              product_id: productId,
              quantity: qty,
              cost_price: product.cost_price || 0,
              sell_price: product.sell_price || 0
            });
          }
        }
      });
      
      if (items.length === 0) {
        alert('add at least one product');
        return;
      }
      
      const result = await apiPost('createDelivery', {
        date: date,
        items: items,
        created_by: currentUser,
        payment_status: 'unpaid'
      });
      
      if (result.success) {
        alert('delivery created!');
        showPage('home');
        loadDeliveries();
      } else {
        alert('error: ' + (result.error || 'unknown'));
      }
    }

    // ADMIN - LOAD PRODUCTS
    async function loadAdminProducts() {
      document.getElementById('adminProductsList').innerHTML = '<div class="loading">loading...</div>';
      const result = await apiCall('getProducts');
      
      if (!result.success || !result.data) {
        document.getElementById('adminProductsList').innerHTML = '<p>error loading</p>';
        return;
      }
      
      const html = result.data.filter(p => p.active).map(p => `
        <div class="product-row">
          <div class="product-name">${p.name} (${p.unit})</div>
          <div class="product-prices">
            <input type="number" step="0.1" value="${p.cost_price || 0}" 
                   onchange="updateProductPrice('${p.id}', 'cost_price', this.value)"
                   placeholder="cost">
            <input type="number" step="0.1" value="${p.sell_price || 0}"
                   onchange="updateProductPrice('${p.id}', 'sell_price', this.value)"
                   placeholder="sell">
          </div>
        </div>
      `).join('');
      
      document.getElementById('adminProductsList').innerHTML = html;
    }

    // UPDATE PRODUCT
    async function updateProductPrice(id, field, value) {
      const result = await apiCall('getProducts');
      if (!result.success) return;
      
      const product = result.data.find(p => String(p.id) === String(id));
      if (!product) return;
      
      product[field] = parseFloat(value) || 0;
      
      await apiPost('updateProduct', product);
      alert('price updated');
    }

    // LOAD AUDIT LOG
    async function loadAuditLog() {
      document.getElementById('auditLogList').innerHTML = '<div class="loading">loading...</div>';
      const result = await apiCall('getAuditLog');
      
      if (!result.success || !result.data || result.data.length === 0) {
        document.getElementById('auditLogList').innerHTML = '<p>no logs</p>';
        return;
      }
      
      const html = result.data.reverse().slice(0, 50).map(log => {
        const timestamp = formatDateTime(log.timestamp) || log.timestamp;
        return `
          <div style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 6px; font-size: 13px;">
            <strong>${timestamp}</strong> | ${log.user} | ${log.action} | ${log.entity} #${log.entity_id}
            <br><small style="color: #7f8c8d;">${log.details}</small>
          </div>
        `;
      }).join('');
      
      document.getElementById('auditLogList').innerHTML = html;
    }

    // INIT
    window.addEventListener('DOMContentLoaded', () => {
      // Auto-login from sessionStorage
      const savedRole = sessionStorage.getItem('userRole');
      if (savedRole && AUTH[savedRole]) {
        currentUser = savedRole;
        currentRole = savedRole;
        document.getElementById('header').style.display = 'block';
        document.getElementById('roleDisplay').textContent = savedRole;
        
        if (savedRole === 'admin') {
          showPage('admin');
        } else {
          showPage('home');
          loadDeliveries();
        }
      } else {
        showPage('login');
      }
      
      const dateInput = document.getElementById('deliveryDate');
      if (dateInput) {
        const normalizedValue = normalizeDeliveryDate(dateInput.value);
        dateInput.value = normalizedValue || normalizeDeliveryDate(new Date());
      }
      
      // Admin page load handlers
      const observer = new MutationObserver(() => {
        const adminProducts = document.querySelector('[data-page="admin-products"]');
        const adminLog = document.querySelector('[data-page="admin-log"]');
        
        if (adminProducts && adminProducts.style.display === 'block' && !adminProducts.dataset.loaded) {
          adminProducts.dataset.loaded = 'true';
          loadAdminProducts();
        }
        
        if (adminLog && adminLog.style.display === 'block' && !adminLog.dataset.loaded) {
          adminLog.dataset.loaded = 'true';
          loadAuditLog();
        }
      });
      
      observer.observe(document.body, { attributes: true, subtree: true, attributeFilter: ['style'] });
    });
  </script>

  <!-- Manager Page -->
  <div data-page="manager">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
      <h1>manager dashboard</h1>
      <button onclick="showNewDelivery()" id="newBtn">+ new delivery</button>
    </div>
    <div id="deliveriesList" class="loading">loading...</div>
  </div>

</body>
</html>
